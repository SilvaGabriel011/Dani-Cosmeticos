generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum PaymentMethod {
  CASH
  PIX
  DEBIT
  CREDIT
}

enum FeeAbsorber {
  SELLER
  CLIENT
}

enum SaleStatus {
  COMPLETED
  PENDING
  CANCELLED
}

enum ReceivableStatus {
  PENDING
  PARTIAL
  PAID
  OVERDUE
}

enum StockMovementType {
  SALE
  CANCELLATION
  ADJUSTMENT
  ENTRY
}

model Category {
  id        String    @id @default(uuid())
  name      String    @unique
  createdAt DateTime  @default(now())
  products  Product[]
}

model Brand {
  id                  String    @id @default(uuid())
  name                String    @unique
  defaultProfitMargin Decimal   @default(35) @db.Decimal(5, 2)
  createdAt           DateTime  @default(now())
  products            Product[]
}

model Product {
  id             String          @id @default(uuid())
  code           String?         @unique
  name           String
  categoryId     String?
  category       Category?       @relation(fields: [categoryId], references: [id])
  brandId        String?
  brand          Brand?          @relation(fields: [brandId], references: [id])
  costPrice      Decimal         @db.Decimal(10, 2)
  profitMargin   Decimal         @db.Decimal(5, 2)
  salePrice      Decimal         @db.Decimal(10, 2)
  stock          Int             @default(0)
  minStock       Int             @default(5)
  packagingType  String?         // CAIXA/KIT/UNIDADE - tipo de embalagem
  isActive       Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  deletedAt      DateTime?
  saleItems      SaleItem[]
  stockMovements StockMovement[]

  @@index([categoryId])
  @@index([brandId])
  @@index([isActive])
  @@index([deletedAt])
}

model Client {
  id         String    @id @default(uuid())
  name       String
  phone      String?
  address    String?
  discount   Decimal   @default(0) @db.Decimal(5, 2)
  importedAt DateTime? // Data de importação via CSV (indica dados incompletos)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deletedAt  DateTime?
  sales      Sale[]

  @@index([deletedAt])
}

model Sale {
  id                     String          @id @default(uuid())
  clientId               String?
  client                 Client?         @relation(fields: [clientId], references: [id])
  subtotal               Decimal         @db.Decimal(10, 2)
  discountPercent        Decimal         @default(0) @db.Decimal(5, 2)
  discountAmount         Decimal         @default(0) @db.Decimal(10, 2)
  totalFees              Decimal         @default(0) @db.Decimal(10, 2)
  total                  Decimal         @db.Decimal(10, 2)
  netTotal               Decimal         @db.Decimal(10, 2)
  paidAmount             Decimal         @default(0) @db.Decimal(10, 2)
  status                 SaleStatus      @default(COMPLETED)
  notes                  String?
  dueDate                DateTime?
  paymentDay             Int?            // Day of month (1-31) for recurring payments
  installmentPlan        Int             @default(1)
  fixedInstallmentAmount Decimal?        @db.Decimal(10, 2) // Fixed amount for each payment (pre-populated in payment modal)
  createdAt              DateTime        @default(now())
  items           SaleItem[]
  payments        Payment[]
  receivables     Receivable[]
  stockMovements  StockMovement[]

  @@index([clientId])
  @@index([status])
  @@index([createdAt])
  @@index([dueDate])
  @@index([status, createdAt])
}

model SaleItem {
  id        String   @id @default(uuid())
  saleId    String
  sale      Sale     @relation(fields: [saleId], references: [id], onDelete: Cascade)
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  quantity  Int
  unitPrice Decimal  @db.Decimal(10, 2)
  costPrice Decimal  @db.Decimal(10, 2)
  total     Decimal  @db.Decimal(10, 2)
  addedAt   DateTime @default(now()) // Date when item was added (for purchase history tracking)

  @@index([saleId])
  @@index([productId])
  @@index([addedAt])
}

model Payment {
  id           String        @id @default(uuid())
  saleId       String
  sale         Sale          @relation(fields: [saleId], references: [id], onDelete: Cascade)
  method       PaymentMethod
  amount       Decimal       @db.Decimal(10, 2)
  feePercent   Decimal       @default(0) @db.Decimal(5, 2)
  feeAmount    Decimal       @default(0) @db.Decimal(10, 2)
  feeAbsorber  FeeAbsorber   @default(SELLER)
  installments Int           @default(1)
  paidAt       DateTime      @default(now())

  @@index([saleId])
  @@index([method])
  @@index([paidAt])
}

model Settings {
  id                   String      @id @default("default")
  debitFeePercent      Decimal     @default(1.5) @db.Decimal(5, 2)
  creditFeePercent     Decimal     @default(3.0) @db.Decimal(5, 2)
  creditInstallmentFee Decimal     @default(4.0) @db.Decimal(5, 2)
  defaultFeeAbsorber   FeeAbsorber @default(SELLER)
  lowStockAlertEnabled Boolean     @default(true)
  updatedAt            DateTime    @updatedAt
}

model Receivable {
  id          String           @id @default(uuid())
  saleId      String
  sale        Sale             @relation(fields: [saleId], references: [id], onDelete: Cascade)
  installment Int
  amount      Decimal          @db.Decimal(10, 2)
  dueDate     DateTime
  paidAmount  Decimal          @default(0) @db.Decimal(10, 2)
  paidAt      DateTime?
  status      ReceivableStatus @default(PENDING)
  createdAt   DateTime         @default(now())

  @@index([saleId])
  @@index([dueDate])
  @@index([status])
  @@index([status, dueDate])
}

model StockMovement {
  id            String            @id @default(uuid())
  productId     String
  product       Product           @relation(fields: [productId], references: [id])
  type          StockMovementType
  quantity      Int
  previousStock Int
  newStock      Int
  saleId        String?
  sale          Sale?             @relation(fields: [saleId], references: [id])
  notes         String?
  createdAt     DateTime          @default(now())

  @@index([productId])
  @@index([type])
  @@index([createdAt])
  @@index([saleId])
}
