generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Category {
  id        String    @id @default(uuid())
  name      String    @unique
  createdAt DateTime  @default(now())
  products  Product[]
}

model Brand {
  id                  String    @id @default(uuid())
  name                String    @unique
  createdAt           DateTime  @default(now())
  defaultProfitMargin Decimal   @default(35) @db.Decimal(10, 2)
  products            Product[]
}

model Product {
  id             String          @id @default(uuid())
  code           String?         @unique
  name           String
  categoryId     String?
  costPrice      Decimal         @db.Decimal(10, 2)
  profitMargin   Decimal         @db.Decimal(10, 2)
  salePrice      Decimal         @db.Decimal(10, 2)
  stock          Int             @default(0)
  minStock       Int             @default(5)
  isActive       Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  deletedAt      DateTime?
  brandId        String?
  fragrancia     String?
  linha          String?
  packagingType  String?
  brand          Brand?          @relation(fields: [brandId], references: [id])
  category       Category?       @relation(fields: [categoryId], references: [id])
  saleItems      SaleItem[]
  stockMovements StockMovement[]
  costEntries    ProductCostEntry[]

  @@unique([brandId, linha, fragrancia, categoryId, packagingType])
  @@index([categoryId])
  @@index([brandId])
  @@index([isActive])
  @@index([deletedAt])
  @@index([linha])
  @@index([fragrancia])
}

model Client {
  id         String    @id @default(uuid())
  name       String
  phone      String?
  address    String?
  discount   Decimal   @default(0) @db.Decimal(5, 2)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deletedAt  DateTime?
  importedAt DateTime?
  sales      Sale[]

  @@index([deletedAt])
}

model Sale {
  id                     String          @id @default(uuid())
  clientId               String?
  subtotal               Decimal         @db.Decimal(10, 2)
  discountPercent        Decimal         @default(0) @db.Decimal(5, 2)
  discountAmount         Decimal         @default(0) @db.Decimal(10, 2)
  totalFees              Decimal         @default(0) @db.Decimal(10, 2)
  total                  Decimal         @db.Decimal(10, 2)
  netTotal               Decimal         @db.Decimal(10, 2)
  status                 SaleStatus      @default(COMPLETED)
  notes                  String?
  createdAt              DateTime        @default(now())
  paidAmount             Decimal         @default(0) @db.Decimal(10, 2)
  dueDate                DateTime?
  installmentPlan        Int             @default(1)
  fixedInstallmentAmount Decimal?        @db.Decimal(10, 2)
  paymentDay             Int?
  payments               Payment[]
  receivables            Receivable[]
  client                 Client?         @relation(fields: [clientId], references: [id])
  items                  SaleItem[]
  stockMovements         StockMovement[]

  @@index([clientId])
  @@index([status])
  @@index([createdAt])
  @@index([dueDate])
  @@index([status, createdAt])
}

model SaleItem {
  id                   String    @id @default(uuid())
  saleId               String
  productId            String
  quantity             Int
  unitPrice            Decimal   @db.Decimal(10, 2)
  originalPrice        Decimal?  @db.Decimal(10, 2)
  costPrice            Decimal   @db.Decimal(10, 2)
  total                Decimal   @db.Decimal(10, 2)
  addedAt              DateTime  @default(now())
  isBackorder          Boolean   @default(false)
  backorderFulfilledAt DateTime?
  product              Product   @relation(fields: [productId], references: [id])
  sale                 Sale      @relation(fields: [saleId], references: [id], onDelete: Cascade)

  @@index([saleId])
  @@index([productId])
  @@index([addedAt])
  @@index([isBackorder])
}

model Payment {
  id           String        @id @default(uuid())
  saleId       String
  method       PaymentMethod
  amount       Decimal       @db.Decimal(10, 2)
  feePercent   Decimal       @default(0) @db.Decimal(5, 2)
  feeAmount    Decimal       @default(0) @db.Decimal(10, 2)
  feeAbsorber  FeeAbsorber   @default(SELLER)
  installments Int           @default(1)
  paidAt       DateTime      @default(now())
  sale         Sale          @relation(fields: [saleId], references: [id], onDelete: Cascade)

  @@index([saleId])
  @@index([method])
  @@index([paidAt])
}

model Settings {
  id                   String      @id @default("default")
  debitFeePercent      Decimal     @default(1.5) @db.Decimal(5, 2)
  creditFeePercent     Decimal     @default(3.0) @db.Decimal(5, 2)
  creditInstallmentFee Decimal     @default(4.0) @db.Decimal(5, 2)
  defaultFeeAbsorber   FeeAbsorber @default(SELLER)
  lowStockAlertEnabled Boolean     @default(true)
  updatedAt            DateTime    @updatedAt
}

model Receivable {
  id          String           @id @default(uuid())
  saleId      String
  installment Int
  amount      Decimal          @db.Decimal(10, 2)
  dueDate     DateTime
  paidAmount  Decimal          @default(0) @db.Decimal(10, 2)
  paidAt      DateTime?
  status      ReceivableStatus @default(PENDING)
  createdAt   DateTime         @default(now())
  sale        Sale             @relation(fields: [saleId], references: [id], onDelete: Cascade)

  @@index([saleId])
  @@index([dueDate])
  @@index([status])
  @@index([status, dueDate])
}

model StockMovement {
  id            String            @id @default(uuid())
  productId     String
  type          StockMovementType
  quantity      Int
  previousStock Int
  newStock      Int
  saleId        String?
  notes         String?
  createdAt     DateTime          @default(now())
  product       Product           @relation(fields: [productId], references: [id])
  sale          Sale?             @relation(fields: [saleId], references: [id])

  @@index([productId])
  @@index([type])
  @@index([createdAt])
  @@index([saleId])
}

model CancelledSaleLog {
  id             String   @id @default(uuid())
  originalSaleId String
  clientName     String?
  total          Decimal  @db.Decimal(10, 2)
  paidAmount     Decimal  @default(0) @db.Decimal(10, 2)
  itemCount      Int
  itemsSummary   String?
  paymentMethods String?
  cancelledAt    DateTime @default(now())
  saleCreatedAt  DateTime
  notes          String?

  @@index([cancelledAt])
}

model ProductCostEntry {
  id        String   @id @default(uuid())
  productId String
  price     Decimal  @db.Decimal(10, 2)
  quantity  Int      @default(1)
  notes     String?
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([createdAt])
}

enum PaymentMethod {
  CASH
  PIX
  DEBIT
  CREDIT
}

enum FeeAbsorber {
  SELLER
  CLIENT
}

enum SaleStatus {
  COMPLETED
  CANCELLED
  PENDING
}

enum ReceivableStatus {
  PENDING
  PARTIAL
  PAID
  OVERDUE
  CANCELLED
}

enum StockMovementType {
  SALE
  CANCELLATION
  ADJUSTMENT
  ENTRY
  BACKORDER
}
